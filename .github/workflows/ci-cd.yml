name: CI-CD

on:
  push:
    branches:
      - main
      - master

jobs:
  tests-dotnet:
    name: Testes .NET (FAS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Executar testes unitários (run-tests.sh)
        run: |
          chmod +x ./run-tests.sh
          ./run-tests.sh

  lint-dashboard:
    name: Lint FAS-Dashboard (Next.js)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "FAS-Dashboard/package-lock.json"

      - name: Instalar dependências
        working-directory: FAS-Dashboard
        run: npm ci --legacy-peer-deps

      - name: Rodar ESLint
        working-directory: FAS-Dashboard
        run: npx eslint .

  build-images:
    name: Build imagens Docker
    runs-on: ubuntu-latest
    needs:
      - tests-dotnet
      - lint-dashboard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build fas-api-properties
        run: docker build -t fas-api-properties:ci ./FAS-Propriedades

      - name: Build fas-api-users
        run: docker build -t fas-api-users:ci ./FAS-Usuarios

      - name: Build ingestion-api
        run: docker build -t ingestion-api:ci ./FAS-DataReceiver

      - name: Build fas-datasender
        run: docker build -t fas-datasender:ci ./FAS-DataSender

  validate-k8s:
    name: Validar manifests Kubernetes
    runs-on: ubuntu-latest
    needs:
      - build-images
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Validar YAML com kubectl (dry-run client)
        run: |
          kubectl apply --dry-run=client --validate=false -f k8s

