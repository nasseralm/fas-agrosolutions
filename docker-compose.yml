# Stack completo: um SQL Server, database AgroSolutions, FAS-Usuarios, FAS-Propriedades, FAS-DataReceiver + Mongo, Redis, Kafka
# Uso: na raiz do repositório: docker compose up -d
# Restore do .bak: ver README ou executar RESTORE manualmente após SQL estar healthy

version: '3.8'

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: fas-sqlserver
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "Your_strong_Passw0rd!"
    ports:
      - "1433:1433"
    volumes:
      - fas_sqlserver_data:/var/opt/mssql
      - .:/backup
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Your_strong_Passw0rd!' -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'Your_strong_Passw0rd!' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  fas-api-properties:
    build:
      context: ./FAS-Propriedades
      dockerfile: Dockerfile
    image: fas-api-properties:dev
    container_name: fas-api-properties
    depends_on:
      sqlserver:
        condition: service_healthy
    ports:
      - "8081:8080"
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Development"
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=AgroSolutions;User Id=sa;Password=Your_strong_Passw0rd!;TrustServerCertificate=True;Encrypt=False"

  fas-api-users:
    build:
      context: ./FAS-Usuarios
      dockerfile: Dockerfile
    image: fas-api-users:dev
    container_name: fas-api-users
    depends_on:
      sqlserver:
        condition: service_healthy
    ports:
      - "8082:8080"
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Development"
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: "false"
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=AgroSolutions;User Id=sa;Password=Your_strong_Passw0rd!;TrustServerCertificate=True;Encrypt=False"

  mongodb:
    image: mongo:7
    container_name: mongodb
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db

  redis:
    image: redis:7
    container_name: redis
    ports:
      - '6379:6379'

  # UIs web para visualizar dados (acesso via /api-docs)
  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    container_name: mongo-express
    depends_on:
      - mongodb
    ports:
      - '8083:8081'
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017
      ME_CONFIG_BASICAUTH: "false"

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    depends_on:
      - redis
    ports:
      - '8084:8081'
    environment:
      REDIS_HOSTS: local:redis:6379

  adminer:
    image: adminer:latest
    container_name: adminer
    depends_on:
      sqlserver:
        condition: service_healthy
    ports:
      - '8085:8080'
    environment:
      ADMINER_DEFAULT_SERVER: sqlserver

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - '2181:2181'

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - '9092:9092'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CREATE_TOPICS: 'agrosolutions.sensor.readings.received.v1:3:1'
    volumes:
      - kafka-data:/var/lib/kafka/data

  ingestion-api:
    build:
      context: ./FAS-DataReceiver
      dockerfile: Dockerfile
    image: ingestion-api:dev
    container_name: ingestion-api
    depends_on:
      sqlserver:
        condition: service_healthy
      mongodb:
        condition: service_started
      redis:
        condition: service_started
      kafka:
        condition: service_started
    ports:
      - '8080:8080'
    environment:
      ASPNETCORE_URLS: http://+:8080
      Kafka__BootstrapServers: kafka:29092
      Kafka__Topic: agrosolutions.sensor.readings.received.v1
      Mongo__ConnectionString: mongodb://mongodb:27017
      Mongo__Database: agrosolutions
      Redis__ConnectionString: redis:6379
      ConnectionStrings__SqlServer: "Server=sqlserver,1433;Database=AgroSolutions;User ID=sa;Password=Your_strong_Passw0rd!;TrustServerCertificate=True;"
      Ingestion__ApiKey: "dev-local-key"

  # Sensores simulados: cada um envia leituras para um talhão do produtor demo (SENS-001->talhão 1, ..., SENS-004->talhão 4)
  # Umidade em faixa normal (45–70%): Initial 55%, Min 45%, Max 70% — status Normal no dashboard
  datasender-1:
    build:
      context: ./FAS-DataSender
      dockerfile: Dockerfile
    image: fas-datasender:dev
    container_name: datasender-1
    depends_on:
      ingestion-api:
        condition: service_started
    environment:
      SensorSimulator__Endpoint: "http://ingestion-api:8080/v1/readings"
      SensorSimulator__ApiKey: "dev-local-key"
      SensorSimulator__DeviceId: "SENS-001"
      SensorSimulator__IntervalSeconds: "15"
      SensorSimulator__Count: "0"
      SensorSimulator__Initial__UmidadeSoloPct: "55"
      SensorSimulator__Ranges__UmidadeMin: "45"
      SensorSimulator__Ranges__UmidadeMax: "70"

  datasender-2:
    image: fas-datasender:dev
    container_name: datasender-2
    depends_on:
      ingestion-api:
        condition: service_started
    environment:
      SensorSimulator__Endpoint: "http://ingestion-api:8080/v1/readings"
      SensorSimulator__ApiKey: "dev-local-key"
      SensorSimulator__DeviceId: "SENS-002"
      SensorSimulator__IntervalSeconds: "15"
      SensorSimulator__Count: "0"
      SensorSimulator__Initial__UmidadeSoloPct: "55"
      SensorSimulator__Ranges__UmidadeMin: "45"
      SensorSimulator__Ranges__UmidadeMax: "70"

  datasender-3:
    image: fas-datasender:dev
    container_name: datasender-3
    depends_on:
      ingestion-api:
        condition: service_started
    environment:
      SensorSimulator__Endpoint: "http://ingestion-api:8080/v1/readings"
      SensorSimulator__ApiKey: "dev-local-key"
      SensorSimulator__DeviceId: "SENS-003"
      SensorSimulator__IntervalSeconds: "15"
      SensorSimulator__Count: "0"
      SensorSimulator__Initial__UmidadeSoloPct: "55"
      SensorSimulator__Ranges__UmidadeMin: "45"
      SensorSimulator__Ranges__UmidadeMax: "70"

  datasender-4:
    image: fas-datasender:dev
    container_name: datasender-4
    depends_on:
      ingestion-api:
        condition: service_started
    environment:
      SensorSimulator__Endpoint: "http://ingestion-api:8080/v1/readings"
      SensorSimulator__ApiKey: "dev-local-key"
      SensorSimulator__DeviceId: "SENS-004"
      SensorSimulator__IntervalSeconds: "15"
      SensorSimulator__Count: "0"
      SensorSimulator__Initial__UmidadeSoloPct: "55"
      SensorSimulator__Ranges__UmidadeMin: "45"
      SensorSimulator__Ranges__UmidadeMax: "70"

volumes:
  fas_sqlserver_data:
  kafka-data:
    driver: local
  mongo-data:
    driver: local
